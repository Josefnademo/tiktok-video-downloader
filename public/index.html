<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TikTok Downloader Pro</title>
    <link rel="icon" href="assets/tdd-icon_type2,1.svg" />
    <style>
      :root {
        --bg: #121212;
        --card: #1e1e1e;
        --primary: #fe2c55; /* TikTok Red */
        --primary-hover: #e0244a;
        --cyan: #25f4ee; /* TikTok Cyan */
        --text: #ffffff;
        --text-gray: #a0a0a0;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        background-color: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        margin-bottom: 30px;
        font-weight: 700;
        letter-spacing: -1px;
      }
      h1 span {
        color: var(--primary);
      }

      /* Card Container */
      .container {
        background-color: var(--card);
        padding: 30px;
        border-radius: 16px;
        width: 100%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        border: 1px solid #333;
      }

      /* Inputs */
      .input-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-size: 0.9em;
        color: var(--text-gray);
      }

      input[type="text"] {
        width: 93%;
        padding: 12px 15px;
        border-radius: 8px;
        border: 1px solid #333;
        background: #2a2a2a;
        color: white;
        font-size: 1em;
        outline: none;
        transition: 0.2s;
      }
      input[type="text"]:focus {
        border-color: var(--cyan);
      }

      /* Folder Select */
      .folder-row {
        display: flex;
        gap: 10px;
      }
      .folder-btn {
        background: #333;
        border: none;
        color: white;
        padding: 0 15px;
        border-radius: 8px;
        cursor: pointer;
        white-space: nowrap;
      }
      .folder-btn:hover {
        background: #444;
      }

      /* Quality Dropdown */
      select {
        width: 100%;
        padding: 12px;
        background: #2a2a2a;
        color: white;
        border: 1px solid #333;
        border-radius: 8px;
        margin-bottom: 20px;
        cursor: pointer;
      }

      /* Main Button */
      .btn-main {
        width: 100%;
        padding: 14px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
      }
      .btn-main:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
      }
      .btn-main:disabled {
        background: #444;
        cursor: not-allowed;
        transform: none;
      }

      /* Status Area */
      .status {
        margin-top: 25px;
        padding: 15px;
        border-radius: 8px;
        font-size: 0.9em;
        line-height: 1.5;
        display: none; /* Hidden by default */
      }
      .status.success {
        background: rgba(37, 244, 238, 0.1);
        border: 1px solid var(--cyan);
        color: var(--cyan);
      }
      .status.error {
        background: rgba(254, 44, 85, 0.1);
        border: 1px solid var(--primary);
        color: var(--primary);
      }

      .status-icon {
        width: 22px;
        height: 22px;
        vertical-align: middle;
        margin-right: 10px;
      }

      .actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }
      .btn-sm {
        flex: 1;
        padding: 10px;
        background: #333;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      .btn-sm:hover {
        background: #444;
      }

      /* Footer Styling */
      footer {
        margin-top: 100px;
        padding-top: 20px;
        border-top: 1px solid #333;
        text-align: center;
        width: 100%;
        max-width: 500px;
      }
      footer img {
        width: 100px;
        height: 100px;
        opacity: 0.95;
        transition: opacity 0.3s ease;
      }
      footer img:hover {
        opacity: 0.8;
      }
      footer p {
        margin: 10px 0 0 0;
        color: var(--text-gray);
        font-size: 0.85em;
        letter-spacing: 0.5px;
      }
      footer .footer-links {
        margin-top: 12px;
        display: flex;
        justify-content: center;
        gap: 20px;
        font-size: 0.8em;
      }
      footer .footer-links a {
        color: var(--cyan);
        text-decoration: none;
        transition: color 0.35s;
      }
      footer .footer-links a:hover {
        color: var(--primary);
      }
    </style>
  </head>
  <body>
    <h1>TikTok <span>Downloader Pro</span></h1>

    <div class="container">
      <div class="input-group">
        <label>Save Location</label>
        <div class="folder-row">
          <input
            type="text"
            id="folderPath"
            value="Downloads/MediaDL"
            readonly
          />
          <button class="folder-btn" id="browseBtn">ðŸ“‚</button>
        </div>
      </div>

      <div class="input-group">
        <label>TikTok URL</label>
        <input type="text" id="urlInput" placeholder="Paste link here..." />
      </div>

      <div class="input-group">
        <label>Preferred Quality</label>
        <select id="qualitySelect">
          <option value="0">Best Available (HD)</option>
          <option value="1">Standard (Data Saver)</option>
        </select>
      </div>

      <button id="downloadBtn" class="btn-main">Download Video</button>

      <div id="statusBox" class="status"></div>

      <div id="resultActions" class="actions" style="display: none">
        <button id="openFolderBtn" class="btn-sm">ðŸ“‚ Open Folder</button>
        <button id="mp3Btn" class="btn-sm">ðŸŽµ Convert to MP3</button>
      </div>
    </div>

    <footer>
      <img src="assets/tdd-icon.svg" alt="TDD Icon" />
      <p>TikTok Downloader Pro</p>
      <p style="font-size: 0.75em; color: #666; margin-top: 5px">
        Download your favorite TikTok videos with ease
      </p>
      <div class="footer-links">
        <a href="https://github.com/Josefnademo" target="_blank">GitHub</a>
        <a href="#">Feedback</a>
        <a href="#">Report Bug</a>
      </div>
    </footer>

    <script>
      const els = {
        url: document.getElementById("urlInput"),
        folder: document.getElementById("folderPath"),
        browse: document.getElementById("browseBtn"),
        quality: document.getElementById("qualitySelect"),
        btn: document.getElementById("downloadBtn"),
        status: document.getElementById("statusBox"),
        actions: document.getElementById("resultActions"),
        openBtn: document.getElementById("openFolderBtn"),
        mp3Btn: document.getElementById("mp3Btn"),
      };

      let selectedFolder = null;
      let lastFilePath = null;

      // Detect environment: Electron or Browser
      const isElectron = typeof window !== "undefined" && window.api;
      const API_TOKEN = "my_strong_token"; // Set via environment variable
      const API_URL = "http://localhost:3000";

      // Hide Electron-only features in browser
      if (!isElectron) {
        if (els.browse) els.browse.style.display = "none";
        if (els.folder) els.folder.style.display = "none";

        // Hide the label for folder path
        const folderLabel = document.querySelector(
          ".input-group:has(#folderPath) > label"
        );
        if (folderLabel) folderLabel.style.display = "none";
      }

      // 1. Browse Folder
      if (els.browse) {
        els.browse.onclick = async () => {
          if (isElectron) {
            // Electron: Use native dialog
            const path = await window.api.selectFolder();
            if (path) {
              selectedFolder = path;
              els.folder.value = path;
            }
          } else {
            // Browser: Just show a text field message
            showStatus(
              "In browser mode, files save to Downloads/MediaDL folder",
              "info"
            );
            selectedFolder = null;
          }
        };
      }

      // 2. Download Logic
      els.btn.onclick = async () => {
        const url = els.url.value.trim();
        if (!url) return showStatus("Please paste a URL first.", "error");

        // UI Reset
        showStatus("Analyzing & Downloading...", "info");
        els.btn.disabled = true;
        els.actions.style.display = "none";

        try {
          let result;

          if (isElectron) {
            // Electron: Use IPC
            result = await window.api.downloadVideo({
              url: url,
              qualityIndex: parseInt(els.quality.value),
              customFolder: selectedFolder,
            });
          } else {
            // Browser: Use HTTP API with streaming download
            const response = await fetch(`${API_URL}/api/download`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "x-api-token": API_TOKEN,
              },
              body: JSON.stringify({
                url: url,
                qualityIndex: parseInt(els.quality.value),
                customFolder: selectedFolder,
              }),
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error || response.statusText);
            }

            // Check if it's a video stream or JSON response
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("video")) {
              // It's a video file - stream it to user's download
              const blob = await response.blob();
              const filename =
                response.headers
                  .get("content-disposition")
                  .split("filename=")[1]
                  .replace(/"/g, "") || "tiktok-video.mp4";

              // Create download link
              const downloadUrl = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = downloadUrl;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(downloadUrl);
              document.body.removeChild(a);

              result = {
                success: true,
                title: filename,
                path: filename,
              };
            } else {
              // It's JSON
              result = await response.json();
            }
          }

          if (result && result.success) {
            showStatus(`Downloaded: ${result.title}`, "success");
            lastFilePath = result.path;
            // Show action buttons only in Electron
            if (isElectron) {
              els.actions.style.display = "flex";
            }
            els.url.value = "";
          } else {
            showStatus(`Error: ${result?.error || "Unknown error"}`, "error");
          }
        } catch (e) {
          showStatus(`System Error: ${e.message}`, "error");
        }

        els.btn.disabled = false;
      };

      // 3. Open Folder (Electron only)
      els.openBtn.onclick = () => {
        if (isElectron && lastFilePath) {
          window.api.openFolder(lastFilePath);
        } else {
          showStatus(
            "This feature is only available in the Electron app",
            "info"
          );
        }
      };

      // 4. Convert MP3 (Electron only)
      els.mp3Btn.onclick = async () => {
        if (!isElectron) {
          showStatus(
            "MP3 conversion is only available in the Electron app",
            "info"
          );
          return;
        }

        if (!lastFilePath) return;
        els.mp3Btn.textContent = "Converting...";

        try {
          const res = await window.api.convertToMp3(lastFilePath);

          if (res.success) {
            showStatus("MP3 Extracted successfully!", "success");
          } else {
            showStatus(`MP3 Failed: ${res.error}`, "error");
          }
        } catch (e) {
          showStatus(`Conversion Error: ${e.message}`, "error");
        }

        els.mp3Btn.textContent = "ðŸŽµ Convert to MP3";
      };

      function showStatus(msg, type) {
        els.status.style.display = "block";
        els.status.className = "status " + type;

        const iconMap = {
          success: "assets/success.svg",
          error: "assets/error.svg",
          info: "assets/info.svg",
        };

        const icon = iconMap[type] || iconMap.info;
        els.status.innerHTML = `<img src="${icon}" class="status-icon" alt="${type}"><span>${msg}</span>`;

        // Simple styling adjustment based on type
        if (type === "info") {
          els.status.style.background = "#333";
          els.status.style.color = "#fff";
          els.status.style.border = "1px solid #555";
        }
      }
    </script>
  </body>
</html>
